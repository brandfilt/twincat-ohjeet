#+TITLE: TwinCat 3 Opas, perusteet
#+STARTUP: showall
* Mikä TwinCat?
TwinCat (The Windows Control and Automation Technology) on Beckhoffin
automaatiojärjestelmien ydin.

Se on PC-pohjainen ohjelmisto, joka muuttaa minkä tahansaPC:n tehokkaaksi automaatiojärjestelmien ohjaimeksi.

TwinCat 3 on ohjelmiston uusin versio, jonka avulla automaatiohjelmointia
voidaan tehdä IEC 61131-3 standardin mukaisten kielten lisäksi C ja C++
ohjelmointikielillä. Twincat 3 on rakennettu Microsoftin Visual Studio
ohjelmointiympäristön päälle.
* Asennus ja ensimmäinen käynnistys
** Vaatimukset
- Windows XP tai uudempi
- Prosessori 1.6Ghz
- 2GB RAM
- 3GB kiintolevytilaa
** Lisenssi
TwinCat 3 lisenssi on täysin ilmainen mutta sen lisenssi on luotava uudelleen 7
päivän välein. Lisenssin aktivointi tapahtuu TwinCat projektin SYSTEM kohdan alla
olevasta License kohdasta.
#+ATTR_HTML: width="300"
#+ATTR_ORG: :width 300
[[file:Lisenssi01.png]]
Kehityskoneen lisenssin voi aktivoida klikkaamalla "Activate 7 Days Trial
License..." ja täyttämällä turvallisuus koodin.
** Virtuaalikoneet
Koska TwinCat ajaa PLC emulaatiota PC:llä saattaa se aiheuttaa ongelmia,
jos samaan aikaan on käytössä muita virtuaalikoineita. TwinCat projektia ei tässä
esimerkiksi pysty asettamaan Run-moodiin, jos samaan aikaan PC:llä on käynnissä VirtualBox.
** Core isolation
TwinCat projekti voidaan ajaa eristettynä yhdellä prosessorin ytimellä Core
Isolation ominaisuuden avulla. Core Isolation löytyy projektin SYSTEM osion alta.
** BIOS asetukset
Hyper-Threading pois päältä
*** Hyper-Threading *pois päältä*
*** Intel Virtualization Technology Extensions (VT-x) *päälle*

* Ensimmäinen PLC projekti
** Uusi projekti
Uusi PLC projekti aloitetaan valitsemalla Visual Studio File valikosta New
Project.

#+ATTR_HTML: :width="300px"
#+ATTR_ORG: :width 50
[[file:kuvat/UusiProjekti01.png]]
Sen jälkeen valitaan Template valikosta TwinCAT Project XAE, annetaan
projektille nimi ja sijainti ja luodaan projekti klikkaamalla OK.

#+ATTR_HTML: width="300"
#+ATTR_ORG: :width 300
[[file:kuvat/UusiProjekti03.png]]
** Asetukset
Ennen kuin aletaan ohjelmoimaan, kannatta projektin asetukset ja lisenssi käydä lävitse.
** PLC projekti
Nyt kun TwinCat projekti on luotu, täytyy siihen vielä lisästä PLC projekti,
jotta päästään ohjelmoimaan. Tämä tapahtuu klikkaamalla hiiren oikealla
puunäkymän kohtaa PLC, ja valitsemalla Add New Item.
[[file:kuvat/LisaaPLCProjekti01.png]]

Avautuvast ikkunasta valitaan projektityypiksi Standard PLC Project, annetaan projektille nimi ja
klikataan OK.
[[file:kuvat/PLCProjekti02.png]]

Projektin puunäkymään PLC-kohdan alle ilmestyy luotu projekti tiedostoineen.
[[file:kuvat/PLCProjektiSisalto01.png]]
*** Kansiorakenne
- External Types
- References
- DUTs
- GVL
  Globaalien muuttujien määrittely. Möyhemmin näihin
  voidaan mäpätä tulot ja lähdöt.
- POU
  Ohjelmat joita PLCllä ajetaan.
- VISUs
** Globaalit muuttujat
Globaalien muuttujien avulla tulot ja lähdöt saadaan helposti liitettyä
ohjelmissa käytettäviin muuttujiin. Muuttujien määrittely onnistuu lisäämällä
GVL kansioon lista, joka sisältää halutut muuttuja. Eri muuttujatyyppejä ovat mm.
BOOL, INT, UINT, REAL, TIME, DATE, ARRAY jne.

Varsinainen määrittely voidaan tehdä joko tekstipohjaisesti, taulukkona tai Auto Declare
dialogin avulla. Teksti- ja taulukkopohjainen määrittely tehdään
muuttujatiedoston muokkauksessa.

Tekstipohjainen muuttujien määrittely tapahtuu formaatissa:
#+BEGIN_SRC
    /muuttujanNimi/ : /tyyppi/;
#+END_SRC
Esim.
#+BEGIN_SRC
    muuttuja1 : BOOL;
#+END_SRC
Muuttujaan voidaan määrittää myös rekisteriosoite, joka voidaan myöhemmin mapata johonkin
fyysiseen tuloon tai lähtöön. Määrittäminen tapahtuu lisäämällä muuttujan nimen
perään AT ja halutun rekisterin tyyppi ja osoite %-merkin jälkeen. Rekisterin
tyyppi ja osoite erotetaan X-kirjaimella.
Esim. input rekisteri 0.0

#+BEGIN_SRC
    /muuttujanNimi/ AT %IX0.0 : /tyyppi/;
#+END_SRC
Asettamalla osoitteen tilalle tähti (*), mapataan osoite automaattisesti.

#+BEGIN_SRC
    /muuttujanNimi/ AT %I* : /tyyppi/;
#+END_SRC
Muuttujat voidaan linkittää johonkin lähtöön tai tuloon I/O valikon alta, kun
laitteet on lisätty.
Output rekisterit määritetään korvaamall I-kirjain Q:lla.

#+BEGIN_SRC
    /muuttujanNimi/ AT %QX0.0 : /tyyppi/;
#+END_SRC

* Ohjelmointi
TwinCat 3 tukee kaikkia IEC 61131-3 standardin mukaisia ohjelmointimenetelmiä,
eli LD (Ladder diagram), FBD (Function Block Diagram), ST (Structured Text), IL
(Instruction List) ja SFC (Sequanteial Function Chart). Tässä ohjeessa käydään
läpi lyhyesti LD, FBD ja ST ohjelmointimenetelmien käyttö TwinCat 3:ssa.
** PLC ohjelman lisäys
** Muuttujien määrittäminen
** Ladder diagram -ohjelmointi
** Fuction Block Diagram -ohjelmointi
** Structured Text -ohjelmointi

* Simulointi
** Projektin simuloiminen TwinCat runtimella
- Aktivoi konfiguraatio
** Ohjelman debuggaus ajon aikana
- PLC ohjelmaa ja muuttujien arvoja voidaan tarkastella ja muuttaa ajon aikana.

* I/O mäppäys laitteisiin
** EtherCat laitteiden lisääminen
** Terminaalimoduulien lisääminen

* HMI käyttöliittymä
** Eri toteutustavat
** Web toteutuksen vaiheet
** UI mäppäys muuttujiin
* Etäyhteys koulun laitteistoon

|-----+---------------+-------|
| CPU | Arkkitehtuuri | Muuta |
|-----+---------------+-------|
| Häh | Jotain        | Ehkä  |
|     |               |       |
|     |               |       |
|     |               |       |

* Ongelmatilanteet


* Lähteet
** https://download.beckhoff.com/download/document/catalog/TwinCAT_3_Booklet.pdf
